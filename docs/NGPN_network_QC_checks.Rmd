---
output:
  html_document:
    css: www/styles.css
    anchor_sections: FALSE
    includes:
      in_header: "header_manual.html"

params:
  year_curr: 2024 # Current year of sampling
  all_years: TRUE # If FALSE, only reports on year_curr; TRUE reports on all years; not enabled yet- currently all years
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = FALSE, vline = "|")
options(knitr.kable.NA = '', scipen = 100)
```

### NGPN QC checks {.tabset}

#### Table structure {.tabset}

```{r libs, include = F}
library(vegcomNGPN)
library(tidyverse) # dplyr, purrr, tidyr
library(knitr) # for kable and include_graphic()
library(kableExtra) # for custom kable features
```

```{r imports, include = F}
importData(type = 'local',
           dbname = c("FFI_RA_AGFO", "FFI_RA_BADL", "FFI_RA_DETO", "FFI_RA_FOLA",
                      "FFI_RA_FOUS", "FFI_RA_JECA", "FFI_RA_KNRI", "FFI_RA_MNRR",
                      "FFI_RA_MORU", "FFI_RA_SCBL", "FFI_RA_THRO", "FFI_RA_WICA"),
           export = F)
```

```{r include = F}
macroplot <- get("MacroPlot", envir = VIEWS_NGPN)
mm_proj_macro <- get("MM_ProjectUnit_MacroPlot", envir = VIEWS_NGPN)
projunit <- get("ProjectUnit", envir = VIEWS_NGPN)

tables <- sort(unique(names(VIEWS_NGPN)))
tblsum <- map(seq_along(tables), function(x){
             get(tables[x], envir = VIEWS_NGPN) |> group_by(datasource) |>
             summarize(Table = tables[x], num_rows = n())
          }) |> list_rbind() |> data.frame() |>
  mutate(park = substr(datasource, nchar(datasource)-3, nchar(datasource)))

tblsum_wide <- tblsum |> select(-datasource) |> pivot_wider(names_from = park, values_from = num_rows) 
tblsum_wide$num_parks <- rowSums(!is.na(tblsum_wide[,2:ncol(tblsum_wide)]))
tblsum_wide$multi_park <- ifelse(tblsum_wide$num_parks > 1, 1, 0)
tblsum_wide <- tblsum_wide |> arrange(desc(multi_park), Table) |> select(-multi_park)

kbl_tbl <- kable(tblsum_wide, format = 'html', align = "c", caption = "Number of records per park per table.") |> 
  kable_styling(fixed_thead = T, bootstrap_options = c("condensed", "striped"), full_width = T, position = 'left', font_size = 10) |> 
  column_spec(1:ncol(tblsum_wide), border_left = "1px solid grey", border_right = "1px solid grey")
  
```

Based on table below, MNRR doesn't have the complete set of tables as other NGPN parks. WICA has additional tables that likely aren't part of NGPN vegetation monitoring, but rather an additional program. 

```{r}
kbl_tbl
```

#### Purpose {.tabset}
```{r include = F}
purpose <- VIEWS_NGPN$MacroPlot |> mutate(park = substr(datasource, nchar(datasource)-3, nchar(datasource))) |> 
  group_by(park, Purpose = MacroPlot_Purpose) |> summarize(num_plots = n(), .groups = 'drop') |> 
  pivot_wider(names_from = park, values_from = num_plots) |> 
  arrange(Purpose)

kbl_purpose <- kable(purpose, format = 'html', align = 'c', captions = 'Number of MacroPlots per purpose per park') |> 
  kable_styling(fixed_thead = T, bootstrap_options = c("condensed", "striped"), full_width = T, position = 'left', font_size = 10) |> 
  column_spec(1:ncol(purpose), border_left = "1px solid grey", border_right = "1px solid grey")

```

```{r}
kbl_purpose
```

#### ProjectUnit {.tabset}
```{r include = F}
# figure out which tables have "ProjectUnit" in them to find the joining keys
cols <- map(seq_along(tables), function(x) names(get(tables[x], env = VIEWS_NGPN))) |> set_names(tables)
cols[grepl("ProjectUnit", cols)==T]

macro2 <- full_join(macroplot, mm_proj_macro, by = c("MacroPlot_GUID" = "MM_MacroPlot_GUID", 'datasource'))
macroproj <- full_join(macro2, projunit, by = c("MM_ProjectUnit_GUID" = "ProjectUnit_GUID", "datasource"))
macroproj$park <- substr(macroproj$datasource, nchar(macroproj$datasource)-3, nchar(macroproj$datasource))
macroproj2 <- macroproj |> 
  mutate(park = substr(datasource, nchar(datasource)-3, nchar(datasource))) |> 
  select(park, MacroPlot_Name, MacroPlot_Purpose, MacroPlot_Type, ProjectUnit_Name) |> 
  group_by(park, MacroPlot_Name, MacroPlot_Purpose, MacroPlot_Type, ProjectUnit_Name) |> 
  summarize(num_rows = n(), .groups = 'drop')

sort(unique(macroproj2$ProjectUnit_Name))
# based on Table 5 of NGPN Plant Community protocol, but not all represented in the data
NGPN_ABAM <- data.frame(park = c("BADL", "BADL", "FOLA", 
                                 "SCBL", "WICA"), 
                        project = c("ABAM Supplemental", "AnnualBrome_Research", "ABAM", 
                                    "AnnualBrome_Research", "ABAM"))
  
vegmon_AGFO <- data.frame(park = "AGFO", 
                          project = c("Park", "Prairie Cluster", "IN-ACTIVE", "Riparian")) 
                          # Does IN-ACTIVE = "Legacy" in table?; Does Native Prairie = Prairie in table?
vegmon_BADL <- data.frame(park = "BADL", project = "North Unit") # What about "Park" and "Prairie"
vegmon_DETO <- data.frame(park = "DETO", project = c("Riparian", "Upland")) 
  # Riparian = Riparian lowland in table? There's also "Park", "Pine Forest" and "Prairie"
vegmon_FOLA <- data.frame(park = "FOLA", project = c("Riparian", "Upland")) #Riparian = Riparian lowland in table?
vegmon_FOUS <- data.frame(park = "FOUS", project = c("Bodmer", "Fort")) # There's also "Park" and "Prairie"
vegmon_JECA <- data.frame(park = "JECA", project = c("Park")) # There's also "Pine Forest"
vegmon_KNRI <- data.frame(park = "KNRI", project = c("Park")) 
vegmon_SCBL <- data.frame(park = "SCBL", project = c("Prairie")) # Park also in data
vegmon_THRO <- data.frame(park = "THRO", 
                          project = c("North Riparian", "North Upland", "South Riparian", "South Upland")) # there's also "Park"
vegmon_WICA <- data.frame(park = "WICA", 
                          project = c("Park", "Pine Forest")) # Not sure if Pine Forest is the 'Currently wooded areas', 
# There's also no Riparian in the data, despite being mentioned in table 6. 

proj_mat <- rbind(NGPN_ABAM, vegmon_AGFO, vegmon_BADL, vegmon_DETO, vegmon_FOLA, 
                  vegmon_FOUS, vegmon_JECA, vegmon_KNRI, vegmon_SCBL, vegmon_THRO, vegmon_WICA)
proj_mat$NGPN = "X"
proj_mat
head(macroproj)

proj_sum <- macroproj |> group_by(Project = ProjectUnit_Name, park = park) |> 
  summarize(num_plots = sum(!is.na(MacroPlot_Name)), .groups = 'drop') |> 
  arrange(park) |> 
  left_join(proj_mat, by = c("park", "Project" = "project")) |> 
  pivot_wider(names_from = park, values_from = num_plots) |> 
  arrange(NGPN, Project)

kbl_proj <- kable(proj_sum, format = 'html', align = 'c', captions = 'Number of MacroPlots per project per park') |> 
  kable_styling(fixed_thead = T, bootstrap_options = c("condensed", "striped"), full_width = T, position = 'left', font_size = 10) |> 
  column_spec(1:ncol(proj_sum), border_left = "1px solid grey", border_right = "1px solid grey")
```

```{r}
kbl_proj
```

